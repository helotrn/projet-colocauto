version: "3.6"
services:
    php:
        build:
            context: .
            target: dev
        depends_on:
            - postgres
            - redis
        volumes:
            - .:/app
            - .env.docker:/app/.env
        ports:
            - 8000:8000
        secrets:
            - source: oauth-private
              target: /app/storage/oauth-private
            - source: oauth-public
              target: /app/storage/oauth-public
        environment:
            LOG_CHANNEL: stderr
            APP_ENV: local
            APP_KEY: base64:QV7VlghMwXOXokIRP1ARpfEuyIF46hfYC/Y/lxFxdVc=
            APP_DEBUG: "true"
            FRONTEND_URL: http://localhost
            APP_URL_EXTERNAL: http://localhost:8000 #this is the url that the browser uses to call us
            DB_HOST: postgres
            DB_PORT: 5432
            DB_CONNECTION: pgsql
            DB_DATABASE: locomotion
            DB_USERNAME: locomotion
            DB_PASSWORD: locomotion
            ENABLE_TEST_ROUTES: "true"
            REDIS_HOST: redis
            REDIS_PORT: 6379
            REDIS_PASSWORD: null
            MAIL_DRIVER: log
            PASSWORD_CLIENT_ID: pTrmRvquBD6mXlep
            PASSWORD_CLIENT_SECRET: 1hu8xmgtXI8O6HRH4zIbRt92X6rSLCgY6NtTNyxN
            S3_KEY: locomotion
            S3_SECRET: locomotion
            S3_REGION: canada
            S3_BUCKET: locomotion
            S3_URL: http://minio:9000
            oauth_private_PATH: /app/storage/oauth-private
            oauth_public_PATH: /app/storage/oauth-public
    vue:
        depends_on:
            - php
        build:
            context: ./resources/app
            target: dev
        volumes:
            - ./resources/app:/app
        ports:
            - 8080:80
        environment:
            BACKEND_URL: http://php:8000
            FRONTEND_URL: localhost:8080
            PORT: 80
    postgres:
        build:
            context: psql
        volumes:
            - postgres-data:/var/lib/postgresql/data
            - ./psql/init:/docker-entrypoint-initdb.d
        ports:
            - 5432:5432
        environment:
            POSTGRES_DB: locomotion
            POSTGRES_PASSWORD: locomotion
            POSTGRES_USER: locomotion
    redis:
        image: redis
        ports:
            - 6379:6379

volumes:
    postgres-data:
secrets:
    oauth-private:
        file: ./secrets/oauth-private.key
    oauth-public:
        file: ./secrets/oauth-public.key
